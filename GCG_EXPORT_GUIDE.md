# GCG Dataset Export Guide

This guide explains how to export GCG attack logs into a comprehensive JSONL dataset using the `export_gcg_dataset.py` script.

## 1. Environment Setup

Ensure you have the repository cloned and the environment set up.

```bash
# Clone the repository (if not already done)
git clone https://github.com/Sizhe-Chen/StruQ
cd StruQ

# Create a conda environment
conda create -n struq python=3.10
conda activate struq

# Install dependencies
pip install -r requirements.txt
```

## 2. Prepare Data

The script requires the original dataset file to map inputs to the attack logs.
Ensure the original data file (e.g., `davinci_003_outputs.json`) is present in the `data/` directory or specify its path.

## 3. Usage

Run the `export_gcg_dataset.py` script pointing to your model folder containing the GCG logs.

### Basic Command

```bash
python export_gcg_dataset.py --model_path <path_to_model_folder> --out_path <output_filename.jsonl>
```

### Arguments

| Argument | Description | Default |
|----------|-------------|---------|
| `--model_path` | **Required.** Path to the model directory containing the `gcg` subdirectory with log files (e.g., `logs/llama-7b-defended`). | N/A |
| `--out_path` | **Required.** Path where the output JSONL file will be saved. | N/A |
| `--data_path` | Path to the original dataset JSON file. | `data/davinci_003_outputs.json` |
| `--only_success`| If set, only successful attacks will be exported. | `False` |

### Example

Assuming you have a model trained and attacked, and the logs are in `checkpoints/llama-7b_StruQ_GCG`:

```bash
python export_gcg_dataset.py \
  --model_path checkpoints/llama-7b_StruQ_GCG \
  --data_path data/davinci_003_outputs.json \
  --out_path gcg_dataset_full.jsonl
```

## 4. Output Format

The generated JSONL file will contain one record per attack attempt with the following fields:

- `id`: Sample ID
- `original_instruction`: The original task instruction
- `original_input`: The original input string
- `adv_input`: The full adversarial input (Input + Injected Prompt + Suffix)
- `gcg_suffix`: The optimized adversarial suffix found by GCG
- `adv_model_output`: The output generated by the model for the adversarial input
- `success_in_response`: Boolean indicating if the attack was successful

## 5. Troubleshooting

- **Missing Logs**: If the script complains about missing GCG logs, ensure the `--model_path` points to the directory *containing* the `gcg` folder (or is the parent of a `*-log` directory).
- **Data Mismatch**: If creating the dataset fails for some IDs, ensure the `--data_path` points to the exact same dataset file used during the attack generation.
